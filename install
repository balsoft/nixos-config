#!/usr/bin/env nix-shell
#!nix-shell -p gnupg git -i bash

firsttime=false
SECRET=true

if [[ $1 == "--first-time" ]]
then
    firsttime=true
    shift
    hostname=$1
    shift
else 
    if [[ $1 == "-no-secret" ]] || [[ $1 == "-s" ]]
       then
           SECRET=false
           shift
    fi
fi

unset IN_NIX_SHELL

$SECRET && {
    gpg -dq secret.nix.gpg > secret.nix
}

# git submodule update --init --recursive

nixpkgs=$(nix-build ./nix/sources.nix -A nixpkgs --no-out-link $@)

export NIX_PATH=nixpkgs=$nixpkgs:nixos-config=/etc/nixos/configuration.nix



if $firsttime
then
    umount /home
    nixos-generate-config --root /mnt
    echo "import /home/balsoft/projects/nixos-config \"$hostname\"" > /mnt/etc/nixos/configuration.nix
    mount --rbind /mnt/home /home/
    cp /mnt/etc/nixos/* /etc/nixos
    nix build -f $nixpkgs/nixos system $@ &&
    nixos-install --system ./result
else
    if [[ -n $INSIDE_EMACS ]]
    then
        nix-build $nixpkgs/nixos -A system $@
    else 
        nix build -f $nixpkgs/nixos system $@
    fi &&
        {
            git add .
            d=$(date +%s)
            git commit -m "Automatic commit. This builds at $d"
            git tag latestBuild --force
            dir=$(pwd)
            export SHELL=/bin/sh 
            pkexec $dir/switch $dir
        }
fi
